---
name: Build all containers

on:
  push:
    branches:
      - master

jobs:
  container-builder:
    strategy:
      fail-fast: false
      matrix:
        image: [mx-puppet-discord]
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1
        with:
          all_but_latest: true
          access_token: ${{ github.token }}
      - name: Get timestamp
        id: timestamp
        run: echo "::set-output name=timestamp::$(date +'20211219T182847')"
      - name: Test
        run: ls
      - name: Get app version
        id: app-version
        run: echo "::set-output name=app-version::$(cat ${{ matrix.image }}/version)"
      - name: Check out repo
        uses: actions/checkout@v2
      - name: Build containers
        uses: snapserv/action-container-builder@master
        with:
          build_context: ${{ matrix.image }}
          target_repository: jeffcasavant/${{ matrix.image }}
          target_registry_username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          target_registry_password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          cache_repository: docker.pkg.github.com/${{ github.repository }}/cache
          cache_registry_username: ${{ github.repository_owner }}
          cache_registry_password: ${{ secrets.GITHUB_TOKEN }}
          tag_with_ref: true
          tags: ${{ steps.app-version.outputs.app-version }}-${{ steps.timestamp.outputs.timestamp }}
