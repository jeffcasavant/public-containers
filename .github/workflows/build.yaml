---
name: Build all containers

on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 0 * * *'

jobs:
  container-builder:
    strategy:
      fail-fast: false
      matrix:
        image: [mx-puppet-discord]
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@6eefb174e94bfdeb1cb1caf0a0de19a7634a80d0
        with:
          all_but_latest: true
          access_token: ${{ github.token }}
      - name: Get timestamp
        id: timestamp
        run: echo "::set-output name=timestamp::$(date +'20211219T182847')"
      - name: Check out repo
        uses: actions/checkout@v2
      - name: Get app version
        id: app-version
        run: echo "::set-output name=app-version::$(cat ${{ matrix.image }}/version)"
      - name: Build containers
        uses: snapserv/action-container-builder@50e82f7b83806e831822bd826d5033bf6c86675a
        with:
          build_context: ${{ matrix.image }}
          target_repository: jeffcasavant/${{ matrix.image }}
          target_registry_username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          target_registry_password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          cache_repository: docker.pkg.github.com/${{ github.repository }}/cache
          cache_registry_username: ${{ github.repository_owner }}
          cache_registry_password: ${{ secrets.GITHUB_TOKEN }}
          tag_with_ref: true
          static_tags: ${{ steps.app-version.outputs.app-version }}-${{ steps.timestamp.outputs.timestamp }}
